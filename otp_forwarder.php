<?php
ignore_user_abort(true);
set_time_limit(0);
ini_set("memory_limit", "320M");

// ‚úÖ TELEGRAM CONFIG
$BOT_TOKEN = "7821825228:AAFJ8cNTGc47Ia-YRisL_ujDKc-lYYUc_Nw";
$CHAT_ID = "-1002052531109";

// ‚úÖ IVASMS Cookie & Token
$XSRF_TOKEN = "eyJpdiI6IllSeW9aamRSNEFpcXFPL2tYV0laOXc9PSIsInZhbHVlIjoiRlo1OUdrbzhzWlZIQjVhSkFkRlhjbHZUdlBxOVNYNTE1M2ZySjZPVnVrTlZVTEJXSENHQ3lUWVd1S2l4c0lJLzJKOU9aWGFCMkxpMGdTV2FScDFnTmh2d1FNaTdwcHdjZzlPTEFhRWJsNklOMk8waGhJenFJM3A4Z3p3TXg3M2UiLCJtYWMiOiI1NjAxODllYzdiYzc0MzBmYWZmOWQ4MGUwOTk4YzQ2MzhmOWE1ZWY0NTI1MmVlMDA2MmY2ZDBkODUwNGVjMWY2IiwidGFnIjoiIn0%3D";

$COOKIES = "_fbp=fb.1.1753150366246.18115314181512568; XSRF-TOKEN=$XSRF_TOKEN; ivas_sms_session=eyJpdiI6ImFvK29uNUI1WEJWU0wrV0pQa3JZZUE9PSIsInZhbHVlIjoiQXFwTnpPNE5MTGZzMzJ1MFhWbHBNRXpnUzNLZmRQbThhYkVxNlFId3gyc0RLYThNN05RWWJaVjl1dVgvWFZNajZJcUkxc3JmalFCdEx5dk9aZDZNMjQ1bzRNNjdac1dCTFIzU3VRR01LUFRDbUdlY09xSGtPamtPUXVlVjZIV1giLCJtYWMiOiI0MzEzMzVkMmUzMjBiYWUwNThjMzdhOTA4ZDFmOTMwMzA1NWQ2MDA0NzJkNDdlNjZiNDc5NjE2NWNjZjBiM2EzIiwidGFnIjoiIn0%3D";

// ‚úÖ KEEP SESSION ALIVE
function keepSessionAlive() {
    global $COOKIES, $XSRF_TOKEN;
    $url = "https://www.ivasms.com/portal/sms/received";
    $headers = [
        "Cookie: $COOKIES",
        "X-XSRF-TOKEN: $XSRF_TOKEN",
        "User-Agent: Mozilla/5.0"
    ];
    $ch = curl_init($url);
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_exec($ch);
    curl_close($ch);
}

// ‚úÖ TELEGRAM SENDER: ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡ßß‡ßß ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°‡ßá ‡ßß‡¶ü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶†‡¶æ‡¶¨‡ßá
function sendTelegramBatch($messages) {
    global $BOT_TOKEN, $CHAT_ID;

    foreach ($messages as $msg) {
        $url = "https://api.telegram.org/bot$BOT_TOKEN/sendMessage";
        $data = [
            "chat_id" => $CHAT_ID,
            "text" => $msg,
            "parse_mode" => "HTML",
            "disable_web_page_preview" => true
        ];
        $ch = curl_init($url);
        curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_exec($ch);
        curl_close($ch);

        sleep(11); // ‚Üê ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶è‡¶ï‡ßá‡¶ï ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶ù‡ßá ‡ßß‡ßß ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶¨‡¶ø‡¶∞‡¶§‡¶ø ‡¶π‡¶¨‡ßá
    }
}

// ‚úÖ COUNTRY DETECTOR
function getCountry($number) {
    $prefixes = [
        "1" => ["ùëºùíèùíäùíïùíÜùíÖ ùë∫ùíïùíÇùíïùíÜùíî", "üá∫üá∏"],
  "7" => ["ùëπùíñùíîùíîùíäùíÇ", "üá∑üá∫"],
  "20" => ["ùë¨ùíàùíöùíëùíï", "üá™üá¨"],
  "27" => ["ùë∫ùíêùíñùíïùíâ ùë®ùíáùíìùíäùíÑùíÇ", "üáøüá¶"],
  "30" => ["ùëÆùíìùíÜùíÜùíÑùíÜ", "üá¨üá∑"],
  "31" => ["ùëµùíÜùíïùíâùíÜùíìùíçùíÇùíèùíÖùíî", "üá≥üá±"],
  "32" => ["ùë©ùíÜùíçùíàùíäùíñùíé", "üáßüá™"],
  "33" => ["ùë≠ùíìùíÇùíèùíÑùíÜ", "üá´üá∑"],
  "34" => ["ùë∫ùíëùíÇùíäùíè", "üá™üá∏"],
  "36" => ["ùëØùíñùíèùíàùíÇùíìùíö", "üá≠üá∫"],
  "39" => ["ùë∞ùíïùíÇùíçùíö", "üáÆüáπ"],
  "40" => ["ùëπùíêùíéùíÇùíèùíäùíÇ", "üá∑üá¥"],
  "41" => ["ùë∫ùíòùíäùíïùíõùíÜùíìùíçùíÇùíèùíÖ", "üá®üá≠"],
  "43" => ["ùë®ùíñùíîùíïùíìùíäùíÇ", "üá¶üáπ"],
  "44" => ["ùëºùíèùíäùíïùíÜùíÖ ùë≤ùíäùíèùíàùíÖùíêùíé", "üá¨üáß"],
  "45" => ["ùë´ùíÜùíèùíéùíÇùíìùíå", "üá©üá∞"],
  "46" => ["ùë∫ùíòùíÜùíÖùíÜùíè", "üá∏üá™"],
  "47" => ["ùëµùíêùíìùíòùíÇùíö", "üá≥üá¥"],
  "48" => ["ùë∑ùíêùíçùíÇùíèùíÖ", "üáµüá±"],
  "49" => ["ùëÆùíÜùíìùíéùíÇùíèùíö", "üá©üá™"],
  "51" => ["ùë∑ùíÜùíìùíñ", "üáµüá™"],
  "52" => ["ùë¥ùíÜùíôùíäùíÑùíê", "üá≤üáΩ"],
  "53" => ["ùë™ùíñùíÉùíÇ", "üá®üá∫"],
  "54" => ["ùë®ùíìùíàùíÜùíèùíïùíäùíèùíÇ", "üá¶üá∑"],
  "55" => ["ùë©ùíìùíÇùíõùíäùíç", "üáßüá∑"],
  "56" => ["ùë™ùíâùíäùíçùíÜ", "üá®üá±"],
  "57" => ["ùë™ùíêùíçùíêùíéùíÉùíäùíÇ", "üá®üá¥"],
  "58" => ["ùëΩùíÜùíèùíÜùíõùíñùíÜùíçùíÇ", "üáªüá™"],
  "60" => ["ùë¥ùíÇùíçùíÇùíöùíîùíäùíÇ", "üá≤üáæ"],
  "61" => ["ùë®ùíñùíîùíïùíìùíÇùíçùíäùíÇ", "üá¶üá∫"],
  "62" => ["ùë∞ùíèùíÖùíêùíèùíÜùíîùíäùíÇ", "üáÆüá©"],
  "63" => ["ùë∑ùíâùíäùíçùíäùíëùíëùíäùíèùíÜùíî", "üáµüá≠"],
  "64" => ["ùëµùíÜùíò ùíÅùíÜùíÇùíçùíÇùíèùíÖ", "üá≥üáø"],
  "65" => ["ùë∫ùíäùíèùíàùíÇùíëùíêùíìùíÜ", "üá∏üá¨"],
  "66" => ["ùëªùíâùíÇùíäùíçùíÇùíèùíÖ", "üáπüá≠"],
  "81" => ["ùë±ùíÇùíëùíÇùíè", "üáØüáµ"],
  "82" => ["ùë∫ùíêùíñùíïùíâ ùë≤ùíêùíìùíÜùíÇ", "üá∞üá∑"],
  "84" => ["ùëΩùíäùíÜùíïùíèùíÇùíé", "üáªüá≥"],
  "86" => ["ùë™ùíâùíäùíèùíÇ", "üá®üá≥"],
"90" => ["ùëªùíñùíìùíåùíÜùíö", "üáπüá∑"],
  "91" => ["ùë∞ùíèùíÖùíäùíÇ", "üáÆüá≥"],
  "92" => ["ùë∑ùíÇùíåùíäùíîùíïùíÇùíè", "üáµüá∞"],
  "93" => ["ùë®ùíáùíàùíâùíÇùíèùíäùíîùíïùíÇùíè", "üá¶üá´"],
  "94" => ["ùë∫ùíìùíä ùë≥ùíÇùíèùíåùíÇ", "üá±üá∞"],
  "95" => ["ùë¥ùíöùíÇùíèùíéùíÇùíì", "üá≤üá≤"],
  "98" => ["ùë∞ùíìùíÇùíè", "üáÆüá∑"],
  "211" => ["ùë∫ùíêùíñùíïùíâ ùë∫ùíñùíÖùíÇùíè", "üá∏üá∏"],
  "212" => ["ùë¥ùíêùíìùíêùíÑùíÑùíê", "üá≤üá¶"],
  "213" => ["ùë®ùíçùíàùíÜùíìùíäùíÇ", "üá©üáø"],
  "216" => ["ùëªùíñùíèùíäùíîùíäùíÇ", "üáπüá≥"],
  "218" => ["ùë¨ùíÑùíñùíÇùíÖùíêùíì", "üá™üá®"],
  "220" => ["ùëÆùíÇùíéùíÉùíäùíÇ", "üá¨üá≤"],
  "221" => ["ùë∫ùíÜùíèùíÜùíàùíÇùíç", "üá∏üá≥"],
  "222" => ["ùë¥ùíÇùíñùíìùíäùíïùíÇùíèùíäùíÇ", "üá≤üá∑"],
  "223" => ["ùë¥ùíÇùíçùíä", "üá≤üá±"],
  "224" => ["ùëÆùíñùíäùíèùíÜùíÇ", "üá¨üá≥"],
  "225" => ["ùë™ùíêùíïùíÜ ùë´‚Äôùë∞ùíóùíêùíäùíìùíÜ", "üá®üáÆ"],
  "226" => ["ùë©ùíñùíìùíåùíäùíèùíÇ ùë≠ùíÇùíîùíê", "üáßüá´"],
  "227" => ["ùëµùíäùíàùíÜùíì", "üá≥üá™"],
  "228" => ["ùëªùíêùíàùíê", "üáπüá¨"],
  "229" => ["ùë©ùíÜùíèùíäùíè", "üáßüáØ"],
  "230" => ["ùë¥ùíÇùíñùíìùíäùíïùíäùíñùíî", "üá≤üá∫"],
  "231" => ["ùë≥ùíäùíÉùíÜùíìùíäùíÇ", "üá±üá∑"],
  "232" => ["ùë∫ùíäùíÜùíìùíìùíÇ ùë≥ùíÜùíêùíèùíÜ", "üá∏üá±"],
  "233" => ["ùëÆùíâùíÇùíèùíÇ", "üá¨üá≠"],
  "234" => ["ùëµùíäùíàùíÜùíìùíäùíÇ", "üá≥üá¨"],
  "235" => ["ùë™ùíâùíÇùíÖ", "üáπüá©"],
  "236" => ["ùë™ùíÜùíèùíïùíìùíÇùíç ùë®ùíáùíìùíäùíÑùíÇùíè ùëπùíÜùíëùíñùíÉùíçùíäùíÑ", "üá®üá´"],
  "237" => ["ùë™ùíÇùíéùíÜùíìùíêùíêùíè", "üá®üá≤"],
  "238" => ["ùë™ùíÇùíëùíÜ ùëΩùíÜùíìùíÖùíÜ", "üá®üáª"],
  "239" => ["ùë∫ùíÇùíê ùëªùíêùíéùíÜ & ùë∑ùíìùíäùíèùíÑùíäùíëùíÜ", "üá∏üáπ"],
  "240" => ["ùë¨ùííùíñùíÇùíïùíêùíìùíäùíÇùíç ùëÆùíñùíäùíèùíÜùíÇ", "üá¨üá∂"],
  "241" => ["ùëÆùíÇùíÉùíêùíè", "üá¨üá¶"],
  "242" => ["ùëπùíÜùíë. ùíêùíá ùë™ùíêùíèùíàùíê", "üá®üá¨"],
  "243" => ["ùë´ùëπ ùë™ùíêùíèùíàùíê", "üá®üá©"],
  "244" => ["ùë®ùíèùíàùíêùíçùíÇ", "üá¶üá¥"],
  "245" => ["ùëÆùíñùíäùíèùíÜùíÇ-ùë©ùíäùíîùíîùíÇùíñ", "üá¨üáº"],
  "246" => ["ùë´ùíäùíÜùíàùíê ùëÆùíÇùíìùíÑùíäùíÇ", "üáÆüá¥"],
  "247" => ["ùë∫ùíï. ùëØùíÜùíçùíÜùíèùíÇ", "üá∏üá≠"],
  "248" => ["ùë∫ùíÜùíöùíÑùíâùíÜùíçùíçùíÜùíî", "üá∏üá®"],
  "249" => ["ùë∫ùíñùíÖùíÇùíè", "üá∏üá©"],
  "250" => ["ùëπùíòùíÇùíèùíÖùíÇ", "üá∑üáº"],
  "251" => ["ùë¨ùíïùíâùíäùíêùíëùíäùíÇ", "üá™üáπ"],
  "252" => ["ùë∫ùíêùíéùíÇùíçùíäùíÇ", "üá∏üá¥"],
  "253" => ["ùë´ùíãùíäùíÉùíêùíñùíïùíä", "üá©üáØ"],
  "254" => ["ùë≤ùíÜùíèùíöùíÇ", "üá∞üá™"],
  "256" => ["ùëºùíàùíÇùíèùíÖùíÇ", "üá∫üá¨"],
  "257" => ["ùë©ùíñùíìùíñùíèùíÖùíä", "üáßüáÆ"],
  "258" => ["ùë¥ùíêùíõùíÇùíéùíÉùíäùííùíñùíÜ", "üá≤üáø"],
  "260" => ["ùíÅùíÇùíéùíÉùíäùíÇ", "üáøüá≤"],
  "261" => ["ùë¥ùíÇùíÖùíÇùíàùíÇùíîùíÑùíÇùíì", "üá≤üá¨"],
  "262" => ["ùëπùíÜùíñùíèùíäùíêùíè", "üá∑üá™"],
  "263" => ["ùíÅùíäùíéùíÉùíÇùíÉùíòùíÜ", "üáøüáº"],
  "264" => ["ùëµùíÇùíéùíäùíÉùíäùíÇ", "üá≥üá¶"],
  "265" => ["ùë¥ùíÇùíçùíÇùíòùíä", "üá≤üáº"],
  "266" => ["ùë≥ùíÜùíîùíêùíïùíâùíê", "üá±üá∏"],
  "267" => ["ùë©ùíêùíïùíîùíòùíÇùíèùíÇ", "üáßüáº"],
  "268" => ["ùë¨ùíîùíòùíÇùíïùíäùíèùíä", "üá∏üáø"],
  "269" => ["ùë™ùíêùíéùíêùíìùíêùíî", "üá∞üá≤"],
  "290" => ["ùë∫ùíï. ùëØùíÜùíçùíÜùíèùíÇ", "üá∏üá≠"],
  "291" => ["ùë¨ùíìùíäùíïùíìùíÜùíÇ", "üá™üá∑"],
"255" => ["ùëªùíÇùíèùíõùíÇùíèùíäùíÇ", "üáπüáø"],
        // ... add more if needed
    ];
    foreach ($prefixes as $prefix => $info) {
        if (strpos($number, $prefix) === 0) return $info;
    }
    return ["Unknown", "üåç"];
}

// ‚úÖ OTP EXTRACTOR
function extractOTP($text) {
    if (preg_match('/\b\d{3,4}[-\s]?\d{3,4}\b/', $text, $m)) return str_replace([' ', '-'], '', $m[0]);
    if (preg_match('/\b\d{6,8}\b/', $text, $m)) return $m[0];
    if (preg_match('/\b\d{3,5}\b/', $text, $m)) return $m[0];
    return "N/A";
}

// ‚úÖ LIVE SMS SCRAPER
function scrapeLiveSMS() {
    global $COOKIES, $XSRF_TOKEN;
    $url = "https://www.ivasms.com/portal/live/test_sms";
    $headers = [
        "Cookie: $COOKIES",
        "X-XSRF-TOKEN: $XSRF_TOKEN",
        "User-Agent: Mozilla/5.0"
    ];
    $ch = curl_init($url);
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    $html = curl_exec($ch);
    curl_close($ch);

    preg_match_all('/<tr class="border-bottom.*?<\/tr>/s', $html, $rows);
    $messagesToSend = [];

    foreach ($rows[0] as $row) {
        preg_match('/CopyText">(\d+)<\/p>/', $row, $num);
        preg_match('/fw-semi-bold ms-2">([^<]+)/', $row, $srv);
        preg_match('/fw-semi-bold">([^<]+)<\/td>/', $row, $msg);
        preg_match('/TerminationDetials\((\d+)\)/', $row, $rid);
        preg_match('/<h6[^>]*>([^<]+)<\/h6>/', $row, $rname);

        $number    = $num[1] ?? '';
        $service   = $srv[1] ?? 'Unknown';
        $message   = html_entity_decode($msg[1] ?? '');
        $rangeID   = $rid[1] ?? 'N/A';
        $rangeName = trim($rname[1] ?? 'N/A');

        if (!$number || !$message) continue;

        list($country, $flag) = getCountry($number);
        $otp = extractOTP($message);
        $now = date("Y-m-d H:i:s");

        $text = "<b>‚òÑÔ∏è ùë∂ùëªùë∑ ùë∫ùë∞ùëÆùëµùë®ùë≥ ùë´ùë¨ùëªùë¨ùë™ùëªùë¨ùë´ ‚òÑÔ∏è</b>\n\n" .
                "<blockquote>‚è±Ô∏è ùëªùíäùíéùíÜ: <code>$now</code></blockquote>\n" .
                "<blockquote>üó∫Ô∏è ùë™ùíêùíñùíèùíïùíìùíö: <code>$country</code> $flag</blockquote>\n" .
                "<blockquote>üì° ùë∫ùíÜùíìùíóùíäùíÑùíÜ: <code>$service</code></blockquote>\n" .
                "<blockquote>üì≤ ùëµùíñùíéùíÉùíÜùíì: <code>$number</code></blockquote>\n" .
                "<blockquote>üß© ùëπùë®ùëµùëÆùë¨ ùë∞ùë´: <code>$rangeID</code></blockquote>\n" .
                "<blockquote>üåä ùëπùë®ùëµùëÆùë¨ ùëµùë®ùë¥ùë¨: <code>$rangeName</code></blockquote>\n" .
                "<blockquote>üì® ùêÖùêÆùê•ùê• ùó†ùóÆùòÄùòÄùóÆùó¥ùó≤:</blockquote>\n" .
                "<blockquote><code>$message</code></blockquote>";

        $messagesToSend[] = $text;
    }

    if (!empty($messagesToSend)) {
        sendTelegramBatch($messagesToSend);
    }
}

// ‚úÖ MAIN EXECUTION
keepSessionAlive();
scrapeLiveSMS();